# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Build Commands (using Pixi)

```bash
# Initialize git submodules (required first time)
pixi run initialize

# Configure and build (debug by default)
pixi run configure        # or configure-release
pixi run build            # or build-release
pixi run install          # or install-release

# Run tests
pixi run test             # or test-release
ctest --test-dir build/debug --output-on-failure  # verbose test output
ctest --test-dir build/debug -R <pattern>         # run specific tests

# Run FreeCAD
pixi run freecad          # or freecad-release
```

## Manual CMake Build

```bash
git submodule update --init --recursive
cmake --preset conda-linux-debug    # or conda-linux-release, conda-macos-*, conda-windows-*
cmake --build build/debug -j$(nproc)
cmake --install build/debug
```

## Code Style

**C++**: Uses clang-format (LLVM-based, Qt style)
- 4-space indent, 100 column limit
- Braces on new line after class/struct/function/namespace
- Pointer/reference alignment: left (`int* ptr`)

**Python**: Uses black formatter
- Line length: 100
- PEP 8 naming: `snake_case` for functions/variables, `CamelCase` for classes

**Pre-commit hooks**: Run `pre-commit run --all-files` before committing. Hooks apply to specific directories (see `.pre-commit-config.yaml` for scope).

## Architecture

### Core (`src/`)
- **Base/**: Foundation utilities (Vector3D, Matrix, Placement, Quantity, Console)
- **App/**: Application core (Document, DocumentObject, PropertyLinks, Transaction, Expression engine)
- **Gui/**: Qt6-based GUI framework, 3D visualization with Coin3D
- **Main/**: Entry point

### Workbenches (`src/Mod/`)
Each workbench follows this structure:
- `App/`: C++ application logic and DocumentObjects
- `Gui/`: ViewProviders and GUI commands
- Python integration throughout

**Key workbenches**:
- **Part**: TopoShape wrapper around OpenCASCADE
- **PartDesign**: Parametric solid modeling (Body, Features)
- **Sketcher**: 2D constraint-based sketching
- **Assembly**: Constraint-based assembly with solver
- **FEM**: Finite element analysis
- **CAM**: Computer-aided manufacturing
- **TechDraw**: Technical drawing generation
- **Draft/BIM**: 2D drafting and building information modeling
- **AIAssistant**: Natural language CAD modeling assistant

### AIAssistant Module (`src/Mod/AIAssistant/`)

Natural language CAD modeling assistant. Uses a code-as-source-of-truth architecture where Claude Code directly edits a Python script that defines the design.

#### Core Concept: Code as Source of Truth

```
┌─────────────────────────────────────────────────────────────────────┐
│                     CODE-FIRST CAD ARCHITECTURE                      │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│   source.py                        FreeCAD Document (.FCStd)         │
│   ───────────                      ─────────────────────────         │
│   Python script that               "Compiled" 3D view of the         │
│   defines the design               design for visualization          │
│                                                                      │
│   • Single source of truth         • Generated by executing          │
│   • Version controllable             source.py                       │
│   • Human-readable history         • Interactive GUI editing         │
│   • Can regenerate document        • Transient runtime state         │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

**Project structure:**
```
MyProject/
├── MyProject.FCStd              # FreeCAD document (GUI state)
└── MyProject/                   # Project folder (named after document)
    ├── source.py                # Python code (source of truth)
    ├── CLAUDE.md                # Project-level instructions for Claude
    ├── activity.log             # User interaction and event log
    ├── sessions/                # Conversation history
    │   └── 001_2026-01-16_10-30.json
    └── snapshots/               # Document state captures
        └── 001_2026-01-16_10-30.json
```

**Project files:**
- **source.py** - Python script that generates the design. Claude edits this directly.
- **CLAUDE.md** - Instructions for Claude when working on this specific project.
- **activity.log** - Timestamped log of all user interactions and system events.
- **sessions/** - JSON files storing conversation history, LLM requests, and linked snapshots.
- **snapshots/** - Point-in-time captures of document state (objects, properties, geometry).

#### How It Works

```
User: "Add a 10mm hole to the center"
                │
                ▼
        ┌───────────────┐
        │  Claude Code  │
        │     CLI       │
        └───────┬───────┘
                │
    ┌───────────┴───────────┐
    │                       │
    ▼                       ▼
Read source.py         Edit source.py
(understand design)    (add hole code)
                            │
                            ▼
                Execute modified source.py
                            │
                            ▼
                FreeCAD document updated
```

1. **User speaks naturally** - "make the box taller", "add a fillet to all edges"
2. **Claude Code reads** - Understands current design from `source.py`
3. **Claude Code edits** - Modifies the relevant Python code directly
4. **FreeCAD executes** - Runs the updated script, document reflects changes

#### Why Code as Source of Truth?

- **No translation layer** - Claude directly writes/edits real Python code
- **Full history** - `source.py` shows how the design evolved over time
- **Git-friendly** - Diff, branch, merge, and review design changes
- **Reproducible** - Run `source.py` on any machine to recreate the design
- **Context-aware** - Claude sees the actual code, not just object properties

#### Module Structure

```
AIAssistant/
├── AIPanel.py                 # Main dock widget, orchestrates UI and requests
├── Theme.py                   # Cursor-inspired dark theme styling
│
├── backends/                  # LLM communication
│   ├── claude_code.py         # Spawns `claude` CLI, allows Read/Edit tools
│   └── http.py                # Legacy HTTP API backend
│
├── core/                      # Business logic
│   ├── context.py             # Builds document context for LLM
│   ├── source.py              # Manages source.py lifecycle, backup/restore
│   ├── snapshot.py            # Captures document state to JSON
│   ├── changes.py             # Detects changes between snapshots
│   ├── executor.py            # Safely executes AI-generated Python
│   └── preview.py             # Shows preview before commit
│
├── persistence/               # Data storage
│   ├── session.py             # Persists chat sessions and LLM debug data
│   └── activity.py            # Logs events to activity.ndjson
│
├── widgets/                   # Qt UI components
│   ├── chat.py                # Chat message display
│   ├── message_model.py       # Data model for messages
│   ├── message_delegate.py    # Message card rendering
│   ├── change.py              # Change visualization widget
│   ├── preview.py             # Preview approval widget
│   ├── plan.py                # Plan approval widget
│   └── ...                    # Other UI widgets
│
└── integration/               # External integrations
    └── parts_library.py       # Parts library scanning and insertion
```

#### core/source.py (SourceManager)

Maintains `source.py` alongside the FreeCAD document:

```python
# FreeCAD AI Source - MyProject
# Created: 2026-01-16 10:30:00

import FreeCAD
import Part

doc = FreeCAD.ActiveDocument or FreeCAD.newDocument("Design")

# === 2026-01-16 10:30:15 ===
# Create base box
box = Part.makeBox(100, 50, 30)
Part.show(box, "BaseBox")

# === 2026-01-16 10:31:22 ===
# Add mounting holes
# ... more code ...
```

Key functions:
- `backup_source()` - Save state before Claude edits (for cancel/restore)
- `restore_source()` - Revert to backup on cancel
- `read_source()` - Get current code for context
- `get_source_path()` - Returns `{doc_dir}/{doc_stem}/source.py`

#### Claude Code Integration

`backends/claude_code.py` invokes the `claude` CLI with:
- `--allowedTools Read,Glob,Grep,Edit` - Can read and edit source.py
- `--output-format stream-json` - Streaming responses
- Working directory set to project folder

System prompt instructs Claude to:
1. Read source.py to understand current design
2. Use Edit tool to modify source.py directly
3. CREATE objects → Add code
4. DELETE objects → Remove code
5. MODIFY objects → Edit existing code

### Key Patterns
- **Property System**: Dynamic properties on DocumentObjects with expression support
- **Extension Architecture**: GroupExtension, GeoFeatureGroupExtension, LinkBaseExtension
- **ViewProvider**: Separates 3D visualization from data model
- **pybind11**: C++/Python bindings

### Dependencies
- OpenCASCADE (OCCT 7.8): Geometry kernel
- Qt6/PySide6: GUI framework
- Coin3D/Pivy: 3D scene graph
- Python 3.11+

## Testing

Tests use Google Test (GTest). Test sources are in `tests/src/` with subdirectories mirroring the module structure. Each workbench can have its own test target (e.g., `Sketcher_tests_run`, `Part_tests_run`).

## Contribution Notes

- PRs should be minimal, addressing exactly one problem
- Each commit must compile independently when merged
- Breaking Python API changes require clear migration documentation
- UI changes require before/after screenshots in PR
- FreeCAD uses a single `main` branch (no topic branches on main repo)
